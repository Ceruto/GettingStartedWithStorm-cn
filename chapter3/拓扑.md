在这一章，你将学到如何在同一个Storm拓扑结构内的不同组件之间传递*tuples*，以及如何向一个运行中的Storm集群发布一个拓扑。

###**数据流组**
设计一个拓扑时，你要做的最重要的事情之一就是定义如何在各组件之间交换数据（数据流是如何被*bolts*消费的）。一个*数据流组*指定了每个*bolt*会消费哪些数据流，以及如何消费它们。

**NOTE**：一个节点能够发布一个以上的数据流，一个数据流组允许我们选择接收哪个。

数据流组在定义拓扑时设置，就像我们在[第二章][1]看到的：
```java
···
    builder.setBolt("word-normalizer", new WordNormalizer())
           .shuffleGrouping("word-reader");
···
```
在前面的代码块里，一个*bolt*由**TopologyBuilder**对象设定， 然后使用随机数据流组指定数据源。数据流组通常将数据源组件的ID作为参数，取决于数据流组的类型不同还有其它可选参数。

**NOTE：**每个**InputDeclarer**可以有一个以上的数据源，而且每个数据源可以分到不同的组。

###**随机数据流组**
随机流组是最常用的数据流组。它只有一个参数（数据源组件），并且数据源会向随机选择的*bolt*发送*tuple*，保证每个消费者收到近似数量的*tuple*。

随机数据流组用于数学计算这样的原子操作。然而，如果操作不能被随机分配，就像[第二章][2]为单词计数的例子，你就要考虑其它分组方式了。

###**域数据流组**
域数据流组允许你基于*tuples*的一个或多个域控制如何把*tuples*发送给*bolts*。它保证拥有相同域组合的值集发送给同一个的*bolt*。回到单词计数器的例子，如果你用*word*域为数据流分组，**word-normalizer** *bolt*将只会把相同单词的*tuples*发送给同一个**word-counter** *bolt*实例。
```java
···
    builder.setBolt("word-counter", new WordCounter(),2)
           .fieldsGrouping("word-normalizer", new Fields("word"));
···
```
**NOTE:** 在域数据流组中的所有域集合必须存在于数据源的域声明中。

###**全部数据流组**
全部数据流组，为每个接收数据的实例复制一份*tuple*副本。这种分组方式用于向*bolts*发送信号。比如，你要刷新缓存，你可以向所有的*bolts*发送一个*刷新缓存信号*。在单词计数器的例子里，你可以使用一个全部数据流组，添加清除计数器缓存的功能（见[拓扑示例][3]）
```java
    public void execute(Tuple input) {
        String str = null;
        try{
            if(input.getSourceStreamId().equals("signals")){
                str = input.getStringByField("action");
                if("refreshCache".equals(str))
                    counters.clear();
            }
        }catch (IllegalArgumentException e){
            //什么也不做
        }
        ···
    }
```
我们添加了一个if分支，用来检查源数据流。Storm允许我们声明具名数据流（如果你不把*tuple*发送到一个具名数据流，默认发送到"**default**"）。这是一个识别*tuples*的极好的方式，就像这个例子中，我们想识别**signals**一样。
在拓扑定义中，你要向**word-counter** *bolt*添加第二个数据流，用来接收从**signals-spout**数据流发送到所有*bolt*实例的每一个*tuple*。
```java
    builder.setBolt("word-counter", new WordCounter(),2)
           .fieldsGroupint("word-normalizer",new Fields("word"))
           .allGrouping("signals-spout","signals");
```
**signals-spout**的实现请参考[git仓库][4]。

###**自定义数据流组**

  [1]: https://github.com/runfriends/GettingStartedWithStorm-cn/blob/master/chapter2/Getting%20Started.md
  [2]: https://github.com/runfriends/GettingStartedWithStorm-cn/blob/master/chapter2/Getting%20Started.md
  [3]: https://github.com/storm-book/examples-ch03-topologies
  [4]: https://github.com/storm-book/examples-ch03-topologies
